<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Tutor Virtual</title>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 40px auto; }
        #respuesta { background-color: #f4f4f4; border-radius: 8px; padding: 16px; min-height: 100px; white-space: pre-wrap; }
        #miPregunta { width: 100%; padding: 8px; box-sizing: border-box; }
        button { padding: 10px 15px; margin-top: 10px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>Mi Tutor Virtual</h1>
    
    <p>Escribe tu pregunta o usa el bot√≥n de grabar:</p>
    <textarea id="miPregunta" rows="3">¬øQu√© ves en esta pantalla?</textarea>
    
    <button id="miBoton">Preguntar (Texto)</button>
    <button id="botonGrabar">Grabar Voz üéôÔ∏è</button>
    <button id="botonPantalla">Analizar Pantalla üñ•Ô∏è</button> <h2>Respuesta de la IA:</h2>
    <div id="respuesta">...esperando...</div>

    <video id="videoPreview" autoplay hidden></video>
    <canvas id="canvasOculto" hidden></canvas>

    <script>
        // --- Referencias a los botones y cajas ---
        const miBoton = document.getElementById('miBoton');
        const botonGrabar = document.getElementById('botonGrabar');
        const botonPantalla = document.getElementById('botonPantalla'); // Nuevo
        const miPregunta = document.getElementById('miPregunta');
        const panelRespuesta = document.getElementById('respuesta');

        // --- MAGIA 1: Escuchar tu voz (Speech-to-Text) ---
        // (Este c√≥digo es el mismo de antes)
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = 'es-ES';
            recognition.continuous = false;
            botonGrabar.onclick = () => {
                panelRespuesta.innerText = "¬°Escuchando... habla ahora!";
                botonGrabar.disabled = true;
                recognition.start();
            };
            recognition.onresult = (event) => {
                miPregunta.value = event.results[0][0].transcript;
                enviarPreguntaSoloTexto(); // Llama a la funci√≥n de solo texto
            };
            recognition.onend = () => { botonGrabar.disabled = false; };
        } else {
            botonGrabar.style.display = 'none';
        }

        // --- MAGIA 2: Leer la respuesta en voz alta (Text-to-Speech) ---
        // (Este c√≥digo es el mismo de antes)
        function leerRespuestaEnVozAlta(texto) {
            const utterance = new SpeechSynthesisUtterance(texto);
            utterance.lang = 'es-ES';
            speechSynthesis.speak(utterance);
        }

        // --- Funci√≥n para enviar SOLO TEXTO ---
        miBoton.onclick = enviarPreguntaSoloTexto;
        
        async function enviarPreguntaSoloTexto() {
            const preguntaUsuario = miPregunta.value;
            if (!preguntaUsuario) return;
            
            // Llama a la funci√≥n central SIN imagen
            await enviarFetch(preguntaUsuario, null);
        }

        // --- ¬°¬°¬°NUEVA MAGIA 3: Capturar Pantalla!!! ---
        botonPantalla.onclick = async () => {
            const preguntaUsuario = miPregunta.value;
            if (!preguntaUsuario) {
                alert("Por favor escribe una pregunta primero (ej: '¬øQu√© ves aqu√≠?')");
                return;
            }

            panelRespuesta.innerText = "Iniciando captura de pantalla... Por favor, comparte tu pantalla.";
            
            try {
                // 1. Pide al usuario que comparta su pantalla
                const stream = await navigator.mediaDevices.getDisplayMedia({ video: true });
                
                const video = document.getElementById('videoPreview');
                const canvas = document.getElementById('canvasOculto');
                const ctx = canvas.getContext('2d');
                
                video.srcObject = stream;
                
                // Espera a que el video se cargue para saber el tama√±o
                video.onloadedmetadata = async () => {
                    panelRespuesta.innerText = "¬°Pantalla capturada! Analizando...";
                    
                    // 2. Dibuja el video en el canvas (¬°El Screenshot!)
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    
                    // 3. Detiene la captura de pantalla
                    stream.getTracks().forEach(track => track.stop());
                    
                    // 4. Convierte el screenshot a texto Base64
                    // Usamos JPEG y calidad 0.8 para reducir el tama√±o
                    const imagenBase64 = canvas.toDataURL('image/jpeg', 0.8);
                    
                    // 5. Llama a la funci√≥n central CON la imagen
                    await enviarFetch(preguntaUsuario, imagenBase64);
                };

            } catch (err) {
                console.error("Error al capturar pantalla:", err);
                panelRespuesta.innerText = "Error. ¬øCancelaste la captura de pantalla?";
            }
        };

        // --- FUNCI√ìN CENTRAL DE FETCH (¬°MEJORADA!) ---
        // Esta funci√≥n ahora decide si enviar solo texto, o texto + imagen
        
        async function enviarFetch(pregunta, imagenBase64) {
            panelRespuesta.innerText = "Pensando...";
            miBoton.disabled = true;
            botonGrabar.disabled = true;
            botonPantalla.disabled = true;

            // Prepara el "cuerpo" del pedido
            let body = { mi_pregunta: pregunta };
            if (imagenBase64) {
                body.mi_imagen = imagenBase64; // A√±ade la imagen si existe
            }

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body) // Env√≠a el cuerpo (con o sin imagen)
                });
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }

                const respuestaTexto = data.respuesta;
                panelRespuesta.innerText = respuestaTexto;
                leerRespuestaEnVozAlta(respuestaTexto);

            } catch (error) {
                console.error("Error en el fetch:", error);
                panelRespuesta.innerText = "¬°Error! " + error.message;
            }

            // Reactiva los botones
            miBoton.disabled = false;
            if (SpeechRecognition) { botonGrabar.disabled = false; }
            botonPantalla.disabled = false;
        }

    </script>

</body>
</html>
